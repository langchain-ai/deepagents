# Check that all uv.lock files are up-to-date
#
# Prevents PRs from being merged when lockfiles are out of sync with pyproject.toml

name: "üîí Check Lockfiles"

on:
  push:
    branches: [main]
  pull_request:
  merge_group:

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

permissions:
  contents: read

jobs:
  check-lockfiles:
    name: "Verify uv.lock files"
    runs-on: ubuntu-latest
    timeout-minutes: 5
    steps:
      - name: "üìã Checkout Code"
        uses: actions/checkout@v6

      - name: "üêç Set up UV"
        uses: astral-sh/setup-uv@v7

      - name: "üîç Check workspace lockfile"
        run: uv lock --check

      - name: "üîç Check example lockfiles"
        run: |
          set -e
          failed_dirs=""
          for dir in examples/text-to-sql-agent examples/content-builder-agent examples/deep_research; do
            echo "::group::Checking $dir"
            if ! uv lock --check --directory "$dir" 2>&1; then
              echo "::error file=$dir/uv.lock::Lockfile is out of sync. Run 'uv lock' in $dir"
              failed_dirs="$failed_dirs $dir"
            else
              echo "‚úÖ $dir/uv.lock is up-to-date"
            fi
            echo "::endgroup::"
          done

          if [ -n "$failed_dirs" ]; then
            echo ""
            echo "‚ùå The following example lockfiles are out of sync:"
            for dir in $failed_dirs; do
              echo "  - $dir/uv.lock"
            done
            echo ""
            echo "To fix, run: uv lock --directory <dir>"
            exit 1
          fi

          echo "‚úÖ All lockfiles are up-to-date!"
